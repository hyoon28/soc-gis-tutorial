## Data visualization

By merging demographic data with spatial boundaries, we can map demographic patterns. When it comes to mapping, it is important to consider what type of variable you intend to display.

 1. Choropleth map
 2. Typology map

We can use or construct demographic variables of interest for mapping. Here, we will create two commonly used variables in urban research: diversity and gentrification.

### Choroleth map

In social science research, scholars often use the Herfindahl-Hirschman Index (HHI) as a measure for diversity. It is an economic index to measure the size of firms in relation to the industry they are in, but the formula is the same as the Simpson diversity index used in ecology, and can be applied to demographic contexts as well. The formula is:

$$
HHI = \sum_{i=1}^{N} (MS_i)^2
$$
Where $MS_i$ is the market share of firm $i$ in the market, and $N$ is the number of firms.

In demographic research, sociologists use the HHI to measure racial diversity of neighborhoods. Instead of market share of firms in a market, we use the shares of racial groups in a neighborhood. 

For example, in a neighborhood with 4 racial groups each representing 25%, the HHI would be:

$$
0.25^2 + 0.25^2 + 0.25^2 + 0.25^2 = 0.25
$$

or, more generally:

$$
HHI = \sum_{i=1}^{4} (0.25)^2 = 0.25
$$

The HHI of 25% means that there is a moderate level of diversity. However, as the HHI goes up, it means the market is more monopolized with less competition, or the neighborhood is predominantly represented by one group.

We can create this diversity measure using the variables we have.

```{r}
# Create the HHI 
sf_joined <- sf_joined %>% 
  mutate(diversity = (pwhite^2 + pblack^2 + phisp^2 + pasian^2)/100)

# Check
sf_joined %>%
  select(diversity)
```


Next, we can create a map displaying how diverse/homogeneous San Francisco neighborhoods are. For relative quantitative variables like the HHI, choroleth maps are useful.


```{r, warning=FALSE, message=FALSE}
ggplot(data = sf_joined) + # specify the source of spatial data
  geom_sf(aes(fill = diversity), 
          size = 0.2,
          color = "white") + # add a layer to use "diversity" to fill colors
  scale_fill_distiller(type="seq", # fill in sequential colors 
                       palette = "Greys",
                       direction = -1, # 1 for low (light) to high (dark), -1 for reverse
                       ) +
  geom_sf_label(aes(label = nhood),  # add labels using the nhood variable
                 size = 1.5, # size of the label text
                 color = "black",         # color of the text
                 fill = "white",          # background fill color
                 label.padding = unit(0.1, "lines"),  # padding around the text
                 label.size = 0,        # thickness of the border around the label
                 alpha = 0.5,             # set transparency of the background
                 check_overlap = TRUE) + # suppress overlaping texts
  theme_void() +
  labs(fill = "HHI") # add a label for legend
```


 - What are the least diverse neighborhoods? Which is the dominant racial group? 
 - What are the most diverse neighborhoods?
 

### Typology map

We've discussed maps suitable for quantitative variables so far. What about for qualitative variables? We use a typology map. We will create a gentrification measure to demonstrate a use case for typology map. Gentrification is a phenomenon that we measure over space and time. While there are multiple ways to define and measure gentrification, for the purposes of this tutorial, we will conceptualize gentrification as a neighborhood-level socioeconomic transformation comprised of both an influx of middle-and upper-class residents and an increase in housing prices in previously low-income, urban neighborhoods.

Our measure of gentrification is calculated at the census tract level from 2000 to 2020, so that we can examine how the socioeconomic composition of neighborhoods in San Francisco changes over time. The four variables listed below are used in our categorical measure of gentrification: 

 * Median household income (in 2020 Dollars)
 * Percent of college-educated residents 
 * Median home value (in 2020 Dollars)
 * Median gross rent (in 2020 Dollars)  
  
The first step in computing the gentrification measure is determining whether or not a tract is **eligible to gentrify (i.e., Gentrifiable).** Generally, researchers consider tracts eligible to gentrify if they are relatively low-income neighborhoods such that they could undergo the revitalization that characterizes gentrification. We will operationalize eligibility to gentrify in a binary fashion using the median household income.

>  **Not Gentrifiable**: Census tracts had a median household income *above* the city-wide median household income at the start of the period. 

> **Gentrifiable**: Census tracts had a median household income *below* the city-wide median household income at the start of the period. 

Next, among the census tracts that were Gentrifiable, we must determine if they were gentrifying over time or not. To classify the gentrifiable tracts as gentrifying or not gentrifying, we will need to calculate how much socioeconomic change and housing value change the tract experienced over the decade and compare the rate of change to the rate in the city. 

> **Gentrifying**: Gentrifiable census tracts that had the socioeconomic status of their residents (i.e., % college graduates OR median household income) grow faster than the city wide-median *AND* the home values (median home value OR median gross rent value) grow faster than the city-wide median over the decade period. 

> **Not Gentrifying**: Gentrifiable census tracts that did NOT experience growth in the socioeconomic status of their residents *AND* their home values at a rate higher than the city-wide median values over the decade period.

This measurement strategy results in a three-category gentrification measure - Not Gentrifiable, Gentrifying, and Not Gentrifying. With these three categories we can make a typology map of census tracts in San Francisco.

```{r}
# In-class assignment
# 1. Determine the boundaries: Should we use census tract or analysis neighborhood boundaries?
#   - Use census tracts.

sftrt_dem <- read.csv("tutorial/data/sftrt_dem.csv")

# Check if it has a common identifier with sftrt
head(sftrt_dem$trt10)
class(sftrt_dem$trt10)

head(sftrt$tractce10)
class(sftrt$tractce10)

# Fill with leading zeros and convert to string
sftrt_dem <- sftrt_dem %>%
  mutate(tractce10 = as.character(sprintf("%06d", trt10)))

# 2. Join demographic data to geometric boundaries
# use either "sfdem.csv" (analysis) or "sftrt_dem.csv" (census tract)

sftrt_joined <- merge(
  x = sftrt,            # sf object
  y = sftrt_dem,           # data frame
  by.x = "tractce10",      # x identifier
  by.y = "tractce10",      # y identifier
  all.x = TRUE,         # keep all lines
)

```

```{r}
# Create a typology map
ggplot(data = sftrt_joined) + 
  geom_sf(aes(fill = gentcat), 
          size = 0.02,
          color = "white") +
  scale_fill_manual(values = c("non-gentrifiable" = "light grey", 
                               "gentrifying" = "pink", 
                               "non-gentrifying" = "black")) +
  theme_void() + # minimalist theme, but keeping the legend
  # customize the legend title and position
  labs(fill = "Gentrification Category", 
       title = "Gentrification in San Francisco") + 
  # customize legend position and map layout (optional)
  theme(legend.position = "right")  # You can also use "bottom" or "left")
```


*Additional Sources for Spatial Data*

Aggregated demographic data and spatial boundaries are collected and disseminated by national and municipal government, as well as international organizations (e.g., United Nations). Additionally, researchers have generated [spatial packages](https://rcarto.github.io/geomatique_avec_r/2001_donnees.html).


