## Spatial join

```{r, include = False}
rm(list=ls())
```

```{r, results='hide', warning=FALSE, message=FALSE}
## Import all layers
nhoods <- st_read("tutorial/data/sfnh_dem_joined.geojson")
restrnt <- st_read("tutorial/data/restaurants.geojson")
```

Spatial join allows you to combine two sf objects based on the spatial relationship between their geometries. For example, we can think of the relationship between neighborhoods (polygons) and restaurants (points).

 * Neighborhoods (x) contain restaurants (y), or
 * restaurants (x) are within neighborhoods (y).

```{r}
# Before joining, check if they have the same projections
st_crs(restrnt) == st_crs(nhoods)

# Perform spatial join
nh_joined <- st_join(x = nhoods, # join
                     y = restrnt, # target
                     join = st_contains, # does x(sfnh/polygon) contains y(sfbnb/point)?
                     left = TRUE) # keep all neighborhoods 
```

## Data visualization

To start, you can simply overlay the restaurant locations on top of the neighborhood map.

```{r}
# Plot the restaurant locations
ggplot() +
  # display neighborhood boundaries
  geom_sf(data = nhoods,
          fill = "lightgray",
          size = 0.02,
          color = "white"
          ) +
  # display restaurants
  geom_sf(data = restrnt, 
          color = "red", 
          size = 0.5, alpha = 0.8
          ) +  # Plot restaurants
  theme_void() +
  labs(title = "Restaurants in San Francisco")
```

Taking a step further, we can create a choropleth map by counting the number of restaurants in each neighborhood.

```{r}
# Step 1: Count restaurants per neighborhood
restaurant_counts <- nh_joined %>%
  group_by(nhood) %>% 
  summarize(n_rst = sum(!is.na(company)), .groups = 'drop')

# Step 2: Create the choropleth map
default_map <- ggplot(data = restaurant_counts) +
  geom_sf(aes(fill = n_rst), # add a layer to use the restaurant count to fill colors
          size = 0.2,
          color = "white") +  # Fill based on restaurant count
  scale_fill_distiller(type="seq", # fill in sequential colors 
                       palette = "Greys",
                       direction = 1, # 1 for low (light) to high (dark), -1 for reverse
                       ) +
  theme_void() +
  labs(fill = "Restaurant Count")

print(default_map)
```

### Determine breaks
```{r}
hist(restaurant_counts$n_rst)
```

```{r}
# Custom breaks
ggplot(data = restaurant_counts) +
  geom_sf(aes(fill = n_rst), # add a layer to use the restaurant count to fill colors
          size = 0.2,
          color = "white") +  
  scale_fill_distiller(type="seq", # fill in sequential colors 
                       palette = "Greys",
                       breaks = c(50, 150, 250), # or you can use quantile binning, natural breaks, etc.
                       direction = 1, # 1 for low (light) to high (dark), -1 for reverse
                       ) +
  theme_void() +
  labs(fill = "Restaurant Count")
```


## Handling missing data
```{r}
# Check neighborhoods that did not get matched with any restaurants
missing_nh <- nh_joined %>%
  filter(is.na(nh_joined$company))

print(missing_nh)

#Check restaurants that did not get matched to neighborhoods
missing_rst <- rst_joined %>%
  filter(is.na(rst_joined$tpop))

print(missing_rst)
```
